<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Invoice Auditor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.6.82/pdf.min.mjs" type="module"></script>
  <style>
    body { font-family: Inter, system-ui, sans-serif; }
    .card { @apply bg-white rounded-2xl shadow-sm border border-slate-200; }
  </style>
</head>
<body class="bg-slate-100 text-slate-900 min-h-screen">
  <header class="bg-slate-900 text-white">
    <div class="max-w-7xl mx-auto px-6 py-10">
      <p class="uppercase tracking-[0.2em] text-xs text-emerald-300 font-semibold">Finance Automation Suite</p>
      <h1 class="text-4xl md:text-5xl font-black mt-3">AI Invoice Auditor</h1>
      <p class="mt-4 text-slate-300 max-w-3xl">Upload invoices from any vendor (PDF, image, scanned, or text), extract key fields, cross-check against contracts/rate cards, and flag overcharges, GST issues, duplicates, and mystery surcharges in minutes.</p>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 py-8 grid lg:grid-cols-12 gap-6">
    <section class="lg:col-span-5 bg-white rounded-2xl shadow-sm border border-slate-200 p-6 space-y-5">
      <h2 class="text-xl font-bold">1) Upload & Extract</h2>
      <input id="invoiceFile" type="file" accept=".pdf,.png,.jpg,.jpeg,.txt,.csv" class="block w-full text-sm" />
      <button id="extractBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 rounded-xl">Run OCR + Extraction</button>
      <p id="status" class="text-sm text-slate-600">Tip: For quick testing, click <span class="font-semibold">Load Demo Invoice</span>.</p>
      <button id="demoBtn" class="w-full border border-slate-300 hover:bg-slate-100 font-semibold py-2.5 rounded-xl">Load Demo Invoice</button>

      <div>
        <label for="rawText" class="block text-sm font-semibold mb-2">Extracted Invoice Text</label>
        <textarea id="rawText" rows="14" class="w-full border border-slate-300 rounded-xl p-3 text-xs font-mono" placeholder="Extracted text will appear here..."></textarea>
      </div>
      <button id="auditBtn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2.5 rounded-xl">2) Audit Against Contracts</button>
    </section>

    <section class="lg:col-span-7 space-y-6">
      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
        <h2 class="text-xl font-bold mb-4">Invoice Summary Dashboard</h2>
        <div class="grid md:grid-cols-4 gap-4">
          <div class="bg-slate-50 rounded-xl p-4 border border-slate-200">
            <p class="text-xs uppercase tracking-wide text-slate-500">Invoice Total</p>
            <p id="invoiceTotal" class="text-2xl font-black">₹0.00</p>
          </div>
          <div class="bg-slate-50 rounded-xl p-4 border border-slate-200">
            <p class="text-xs uppercase tracking-wide text-slate-500">Expected Total</p>
            <p id="expectedTotal" class="text-2xl font-black">₹0.00</p>
          </div>
          <div class="bg-slate-50 rounded-xl p-4 border border-slate-200">
            <p class="text-xs uppercase tracking-wide text-slate-500">Potential Recovery</p>
            <p id="overchargeTotal" class="text-2xl font-black text-rose-600">₹0.00</p>
          </div>
          <div class="bg-slate-50 rounded-xl p-4 border border-slate-200">
            <p class="text-xs uppercase tracking-wide text-slate-500">Risk Flags</p>
            <p id="flagCount" class="text-2xl font-black">0</p>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
        <h2 class="text-xl font-bold mb-4">Extracted Structured Data</h2>
        <pre id="structuredOutput" class="bg-slate-900 text-emerald-300 rounded-xl p-4 text-xs overflow-auto max-h-64">No extraction yet.</pre>
      </div>

      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
        <h2 class="text-xl font-bold mb-4">Audit Findings</h2>
        <div id="findings" class="space-y-3 text-sm">
          <p class="text-slate-500">No audit run yet.</p>
        </div>
      </div>
    </section>
  </main>

  <script type="module">
    const CONTRACTS = {
      "SwiftLogistics Pvt Ltd": {
        gstin: "27AAECS9988L1ZQ",
        rates: {
          "line haul": 2200,
          "fuel surcharge": 350,
          "handling": 500
        },
        gstRate: 18,
        hsn: ["996511", "996519"]
      },
      "Prime Raw Materials": {
        gstin: "29AAICP4412R1ZT",
        rates: {
          "polymer resin": 82,
          "packaging": 8
        },
        gstRate: 18,
        hsn: ["390120", "392310"]
      }
    };

    const HISTORICAL_INVOICES = [
      { invoiceNo: "INV-2025-00108", vendor: "SwiftLogistics Pvt Ltd", total: 42350, date: "2025-05-04" },
      { invoiceNo: "INV-2025-00109", vendor: "SwiftLogistics Pvt Ltd", total: 39850, date: "2025-05-11" },
      { invoiceNo: "PRM-8872", vendor: "Prime Raw Materials", total: 102760, date: "2025-05-09" }
    ];

    const DEMO_TEXT = `Vendor: SwiftLogistics Pvt Ltd
GSTIN: 27AAECS9988L1ZQ
Invoice Number: INV-2025-00109
Invoice Date: 2025-05-11
HSN: 996511
Line Item: Line Haul | Qty: 12 | Rate: 2350 | Amount: 28200
Line Item: Fuel Surcharge | Qty: 12 | Rate: 420 | Amount: 5040
Line Item: Handling | Qty: 4 | Rate: 500 | Amount: 2000
Line Item: Peak Season Fee | Qty: 1 | Rate: 3000 | Amount: 3000
Subtotal: 38240
GST Rate: 12%
GST Amount: 4588.8
Invoice Total: 42828.8`;

    const statusEl = document.getElementById('status');
    const rawTextEl = document.getElementById('rawText');
    const structuredOutput = document.getElementById('structuredOutput');
    const findingsEl = document.getElementById('findings');
    const fileInput = document.getElementById('invoiceFile');

    document.getElementById('demoBtn').addEventListener('click', () => {
      rawTextEl.value = DEMO_TEXT;
      statusEl.textContent = 'Demo invoice loaded. Click “Audit Against Contracts”.';
    });

    document.getElementById('extractBtn').addEventListener('click', async () => {
      const file = fileInput.files?.[0];
      if (!file) {
        statusEl.textContent = 'Please upload a file first.';
        return;
      }

      statusEl.textContent = 'Extracting text...';
      try {
        const text = await extractText(file);
        rawTextEl.value = text.trim();
        statusEl.textContent = 'Extraction complete. Review text and run audit.';
      } catch (error) {
        statusEl.textContent = `Extraction failed: ${error.message}`;
      }
    });

    document.getElementById('auditBtn').addEventListener('click', () => {
      const raw = rawTextEl.value;
      if (!raw.trim()) {
        statusEl.textContent = 'No text found. Upload or load demo invoice first.';
        return;
      }

      const structured = parseInvoice(raw);
      const audit = runAudit(structured);
      render(structured, audit);
      statusEl.textContent = 'Audit complete. Review flags and recovery amount.';
    });

    function parseInvoice(text) {
      const data = {
        vendor: find(text, /Vendor\s*:\s*(.+)/i),
        gstin: find(text, /GSTIN\s*:\s*([A-Z0-9]+)/i),
        invoiceNo: find(text, /Invoice\s*(Number|No)\s*:\s*([A-Z0-9\-\/]+)/i, 2),
        invoiceDate: find(text, /Invoice\s*Date\s*:\s*([\d\-\/]+)/i),
        hsn: find(text, /HSN\s*:\s*(\d{4,8})/i),
        gstRate: Number(find(text, /GST\s*Rate\s*:\s*(\d+(?:\.\d+)?)%?/i) || 0),
        gstAmount: Number(find(text, /GST\s*Amount\s*:\s*([\d.]+)/i) || 0),
        subtotal: Number(find(text, /Subtotal\s*:\s*([\d.]+)/i) || 0),
        invoiceTotal: Number(find(text, /(Invoice\s*Total|Total\s*Amount)\s*:\s*([\d.]+)/i, 2) || 0),
        items: []
      };

      const lineRegex = /Line\s*Item\s*:\s*([^|\n]+)\|\s*Qty\s*:\s*([\d.]+)\|\s*Rate\s*:\s*([\d.]+)\|\s*Amount\s*:\s*([\d.]+)/gi;
      let match;
      while ((match = lineRegex.exec(text)) !== null) {
        data.items.push({
          description: match[1].trim(),
          qty: Number(match[2]),
          rate: Number(match[3]),
          amount: Number(match[4])
        });
      }

      if (!data.subtotal && data.items.length) {
        data.subtotal = round2(data.items.reduce((sum, item) => sum + item.amount, 0));
      }

      return data;
    }

    function runAudit(invoice) {
      const findings = [];
      const contract = CONTRACTS[invoice.vendor];
      let expectedSubtotal = 0;

      if (!contract) {
        findings.push(makeFlag('high', 'Missing contract/rate card', `No contract profile found for vendor “${invoice.vendor || 'Unknown'}”.`));
      }

      for (const item of invoice.items) {
        const key = item.description.toLowerCase().trim();
        const contractRate = contract?.rates[key];

        if (contractRate === undefined) {
          findings.push(makeFlag('medium', 'Mystery surcharge', `Line item “${item.description}” is not present in approved rate card.`));
          expectedSubtotal += item.amount;
          continue;
        }

        const expectedAmount = round2(item.qty * contractRate);
        expectedSubtotal += expectedAmount;

        if (item.rate > contractRate) {
          findings.push(makeFlag('high', 'Rate overcharge', `“${item.description}” billed at ₹${item.rate} vs contracted ₹${contractRate}. Potential excess: ₹${round2(item.amount - expectedAmount)}.`));
        }

        const recomputed = round2(item.qty * item.rate);
        if (Math.abs(recomputed - item.amount) > 0.5) {
          findings.push(makeFlag('medium', 'Calculation mismatch', `“${item.description}” line amount should be ₹${recomputed}, but invoice shows ₹${item.amount}.`));
        }
      }

      const duplicate = HISTORICAL_INVOICES.find(h => h.invoiceNo === invoice.invoiceNo && h.vendor === invoice.vendor);
      if (duplicate) {
        findings.push(makeFlag('high', 'Possible duplicate invoice', `Invoice number ${invoice.invoiceNo} already exists in historical records dated ${duplicate.date}.`));
      }

      if (contract && invoice.gstRate && invoice.gstRate !== contract.gstRate) {
        findings.push(makeFlag('high', 'GST rate mismatch', `Invoice GST is ${invoice.gstRate}% but contract expects ${contract.gstRate}%.`));
      }

      if (contract && invoice.hsn && !contract.hsn.includes(invoice.hsn)) {
        findings.push(makeFlag('medium', 'HSN code mismatch', `HSN ${invoice.hsn} not found in approved codes (${contract.hsn.join(', ')}).`));
      }

      const expectedGst = round2(expectedSubtotal * ((contract?.gstRate || invoice.gstRate || 0) / 100));
      const expectedTotal = round2(expectedSubtotal + expectedGst);
      const billedTotal = invoice.invoiceTotal || round2(invoice.subtotal + invoice.gstAmount);
      const overcharge = Math.max(0, round2(billedTotal - expectedTotal));

      if (Math.abs((invoice.subtotal || 0) - round2(invoice.items.reduce((s, i) => s + i.amount, 0))) > 0.5) {
        findings.push(makeFlag('medium', 'Subtotal mismatch', `Subtotal does not match sum of line items.`));
      }

      return { findings, expectedSubtotal, expectedGst, expectedTotal, billedTotal, overcharge };
    }

    function render(invoice, audit) {
      structuredOutput.textContent = JSON.stringify(invoice, null, 2);
      document.getElementById('invoiceTotal').textContent = formatINR(audit.billedTotal);
      document.getElementById('expectedTotal').textContent = formatINR(audit.expectedTotal);
      document.getElementById('overchargeTotal').textContent = formatINR(audit.overcharge);
      document.getElementById('flagCount').textContent = String(audit.findings.length);

      if (!audit.findings.length) {
        findingsEl.innerHTML = '<p class="text-emerald-700 font-semibold">No discrepancies detected.</p>';
        return;
      }

      const styleMap = {
        high: { wrap: 'border-rose-200 bg-rose-50', title: 'text-rose-800', body: 'text-rose-900' },
        medium: { wrap: 'border-amber-200 bg-amber-50', title: 'text-amber-800', body: 'text-amber-900' },
        low: { wrap: 'border-blue-200 bg-blue-50', title: 'text-blue-800', body: 'text-blue-900' }
      };

      findingsEl.innerHTML = audit.findings.map(flag => {
        const style = styleMap[flag.severity] || styleMap.low;
        return `<div class="border ${style.wrap} rounded-xl p-4">
          <p class="font-bold ${style.title}">${flag.type}</p>
          <p class="${style.body} mt-1">${flag.message}</p>
        </div>`;
      }).join('');
    }

    function makeFlag(severity, type, message) {
      return { severity, type, message };
    }

    function find(text, regex, group = 1) {
      const m = text.match(regex);
      return m ? m[group].trim() : '';
    }

    function round2(val) {
      return Math.round((val + Number.EPSILON) * 100) / 100;
    }

    function formatINR(value) {
      return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 2 }).format(value || 0);
    }

    async function extractText(file) {
      const name = file.name.toLowerCase();
      if (name.endsWith('.txt') || name.endsWith('.csv')) {
        return await file.text();
      }

      if (name.endsWith('.pdf')) {
        const { getDocument } = await import('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.6.82/pdf.min.mjs');
        const bytes = await file.arrayBuffer();
        const pdf = await getDocument({ data: bytes }).promise;
        let text = '';
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          text += content.items.map(item => item.str).join(' ') + '\n';
        }
        return text;
      }

      if (name.endsWith('.png') || name.endsWith('.jpg') || name.endsWith('.jpeg')) {
        const worker = await import('https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.esm.min.js');
        const { data } = await worker.recognize(file, 'eng');
        return data.text;
      }

      throw new Error('Unsupported format. Upload PDF, image, TXT, or CSV.');
    }
  </script>
</body>
</html>
